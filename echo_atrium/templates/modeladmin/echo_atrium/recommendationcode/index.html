{% extends "wagtailadmin/base.html" %}
{% load i18n wagtailadmin_tags %}

{% block extra_css %}
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.17/dist/tailwind.min.css" rel="stylesheet">
{% endblock %}

{% include "wagtailadmin/shared/pagination_nav.html" with items=user_profiles %}


{% block content %}
    <header class="py-4 px-8 bg-gray-100">
        <div class="flex justify-between items-center">
            <h1 class="text-2xl font-semibold">{% trans "Recommendation Codes" %}</h1>
            <div class="flex items-center">
                <form class="flex items-center" action="." method="GET" novalidate>
                    <input type="text" name="q" placeholder="{% trans 'Search codes and usernames' %}"
                           value="{{ search_query|default:'' }}"
                           class="border border-gray-300 px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"/>
                    <button type="submit"
                            class="ml-2 text-white bg-indigo-500 px-4 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">{% trans 'Search' %}</button>
                </form>
            </div>
        </div>
    </header>

    <form method="POST" action=".">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="create_form"/>
        {{ form.username.label_tag }} {{ form.username }}
        {{ form.password.label_tag }} {{ form.password }}
        {{ form.level.label_tag }} {{ form.level }}
        {{ form.badge.label_tag }} {{ form.badge }}
        {{ form.recommendation_code.label_tag }} {{ form.recommendation_code }}
        {{ form.use_limit.label_tag }} {{ form.use_limit }}  <!-- Add use_limit field -->
        {{ form.times_used.label_tag }} {{ form.times_used }}  <!-- Add times_used field -->
        <button type="submit"
                class="text-white w-full h-16 bg-indigo-400 px-4 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">{% trans 'Add' %}</button>
    </form>

    <table class="min-w-full divide-y divide-gray-200 mt-6">
        <thead class="bg-gray-50">
        <tr>
            <th class="px-8 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "Code" %}</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "User" %}</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "Created At" %}</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "Level" %}</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "Badge" %}</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "Exp" %}</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "Credits" %}</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "Invited By" %}</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "Invited Users" %}</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "Actions" %}</th>
        </tr>
        </thead>
        {% for user_profile in user_profiles %}
            <tr>
                <!-- Form to update a user -->
                <form method="POST" action=".">
                    {% csrf_token %}
                    <input type="hidden" name="form_type" value="update_form"/>
                    <input type="hidden" name="user_id" value="{{ user_profile.user.id }}"/>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% with user_profile.recommendationcode_set.all|first as recommendation_code %}
                            <div class="grid grid-rows-2 gap-1">
                                <!-- Top part -->
                                <div>
                                    <input type="text" name="recommendation_code" value="{{ recommendation_code.code }}"
                                           class="border border-gray-300 px-3 py-2 text-sm rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"/>
                                </div>
                                <!-- Bottom part -->
                                <div class="grid grid-cols-2 gap-1">
                                    <input type="number" name="use_limit" value="{{ recommendation_code.use_limit }}"
                                           class="border border-gray-300 px-3 py-2 text-sm rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"/>
                                    <!-- Add use_limit field -->
                                    <input type="number" name="times_used" value="{{ recommendation_code.times_used }}"
                                           class="border border-gray-300 px-3 py-2 text-sm rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"/>
                                    <!-- Add times_used field -->
                                </div>
                            </div>
                        {% endwith %}
                    </td>


                    </td>

                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="text" name="username" value="{{ user_profile.user.username }}"/>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">{{ user_profile.user.date_joined|date:'Y-m-d H:i:s' }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="number" name="level" value="{{ user_profile.level }}"/>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="text" name="badge" value="{{ user_profile.badge }}"/>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="number" name="exp" value="{{ user_profile.exp }}"/>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="number" name="credits" value="{{ user_profile.credits }}"/>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if user_profile.invited_by %}
                            <input type="text" name="invited_by" value="{{ user_profile.invited_by.user.username }}"/>
                        {% else %}
                            <input type="text" name="invited_by" value=""/>
                        {% endif %}


                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {% for username in user_profile.invited_users_list %}
                            <div>{{ username }}</div>
                        {% endfor %}
                    </td>

                    <td class="px-6 py-4 whitespace-nowrap">
                        <button type="submit"
                                class="text-white bg-indigo-500 px-4 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            {% trans 'Save' %}
                        </button>
                    </td>
                </form>
            </tr>
        {% empty %}
            <tr>
                <td colspan="10" class="px-6 py-4 whitespace-nowrap">{% trans "No users found." %}</td>
            </tr>
        {% endfor %}
        }

    </table>
    {% include "wagtailadmin/shared/pagination_nav.html" with items=recommendation_codes %}
{% endblock %}
{% block extra_js %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('add-code-button').addEventListener('click', function () {
                document.getElementById('add-code-modal').classList.remove('hidden');
            });

            document.getElementById('cancel-button').addEventListener('click', function () {
                document.getElementById('add-code-modal').classList.add('hidden');
            });
        });
    </script>
{% endblock %}

