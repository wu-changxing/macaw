{% load wagtailcore_tags static %}

{% block extra_css %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/share_block.css' %}">
{% endblock %}



<div class="mb-20 share-block" id="share_block_{{ block_id }}" data-color-index="0">
<div class="share-block-inner">
    <div id="share_content_{{ block_id }}" style="background-image: url('{{ cover_image_url }}'); background-size: cover; ">

        <div class="block-content">
            {% include_block block_content %}
        </div>

        <div class="info-footer">
            <div class="title">
                《{{ page_title }}》
            </div>
            <div class="author-info">
                {% for item in authors %}
                    <span class="author-name">
                        {{ item.author.name }}
                    </span>
                {% endfor %}
            </div>
            <div class="date-info">
                {{ page_date }}
            </div>
        </div>

    </div>
</div>
    <button class="share-button" data-block-id="{{ block_id }}" type="button">Share</button>
    <button class="change-bg-button" data-block-id="{{ block_id }}" type="button">Change Background</button>
</div>

{% block extra_js %}


<script>
    document.addEventListener('DOMContentLoaded', (event) => {
       const colorPairs = getComputedStyle(document.documentElement).getPropertyValue('--color-pairs').split(',').map(pair => pair.trim().split('/'));
    const blocks = document.querySelectorAll('.share-block');

    blocks.forEach((block, index) => {
        const blockContent = block.querySelector('.block-content');
        const [bgColor, textColor] = colorPairs[index % colorPairs.length];
        blockContent.style.backgroundColor = bgColor;
        blockContent.style.color = textColor;
        block.setAttribute('data-color-index', index % colorPairs.length);
    });

    const changeBgButtons = document.querySelectorAll('.change-bg-button');

    changeBgButtons.forEach((btn) => {
        btn.addEventListener('click', function() {
            const blockId = this.getAttribute('data-block-id');
            const block = document.getElementById('share_block_' + blockId);
            const blockContent = block.querySelector('.block-content');
            let colorIndex = parseInt(block.getAttribute('data-color-index'), 10);

            colorIndex = (colorIndex + 1) % colorPairs.length;
            const [nextBgColor, nextTextColor] = colorPairs[colorIndex];

            blockContent.style.backgroundColor = nextBgColor;
            blockContent.style.color = nextTextColor;
            block.setAttribute('data-color-index', colorIndex);
        });
    });

        const shareButtons = document.querySelectorAll('.share-button');
        shareButtons.forEach((btn) => {
            btn.addEventListener('click', function() {
                const blockId = this.getAttribute('data-block-id');
                const node = document.getElementById('share_content_' + blockId);
                let scale = 2;
                let style = {
                    transform: `scale(${scale})`,
                    transformOrigin: 'top left'
                };

                domtoimage.toBlob(node, {
                    width: node.clientWidth * scale,
                    height: node.clientHeight * scale,
                    style: style
                })
                .then(function (blob) {
                    saveAs(blob, 'shared_image'+blockId+'.png');
                })
                .catch(function (error) {
                    console.error('Error generating image', error);
                });
            });
        });
    });


</script>
{% endblock %}
